<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Processor App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6d28d9;
            --primary-light: #8b5cf6;
            --secondary: #10b981;
            --accent: #f97316;
            --background-dark: #111827;
            --background-light: #f9fafb;
            --text-dark: #1f2937;
            --text-light: #f3f4f6;
            --card-dark: rgba(31, 41, 55, 0.7);
            --card-light: rgba(255, 255, 255, 0.7);
            --border-dark: rgba(55, 65, 81, 0.8);
            --border-light: rgba(209, 213, 219, 0.8);
            --shadow-color-dark: rgba(0, 0, 0, 0.3);
            --shadow-color-light: rgba(107, 114, 128, 0.2);
            --danger: #ef4444;
            --danger-light: #f87171;
            --input-bg-dark: rgba(55, 65, 81, 0.8);
            --input-bg-light: rgba(255, 255, 255, 0.9);
            --dropdown-bg-dark: #2d3748;
            --dropdown-bg-light: #ffffff;
            --option-hover-dark: rgba(75, 85, 99, 0.7);
            --option-hover-light: #f7fafc;
        }

        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Theme specific styles */
        .dark {
            background-color: var(--background-dark);
            color: var(--text-light);
            --card-bg: var(--card-dark);
            --border-color: var(--border-dark);
            --shadow-color-current: var(--shadow-color-dark);
            --input-bg: var(--input-bg-dark);
            --th-bg: rgba(31, 41, 55, 0.9);
            --hover-bg: rgba(55, 65, 81, 0.5);
            --selected-bg: rgba(139, 92, 246, 0.2);
            --details-bg: rgba(55, 65, 81, 0.2);
            --markdown-pre-bg: rgba(55, 65, 81, 0.7);
            --markdown-code-bg: rgba(75, 85, 99, 0.7);
            --dropdown-bg: var(--dropdown-bg-dark);
            --option-hover: var(--option-hover-dark);
        }

        .light {
            background-color: var(--background-light);
            color: var(--text-dark);
            --card-bg: var(--card-light);
            --border-color: var(--border-light);
            --shadow-color-current: var(--shadow-color-light);
            --input-bg: var(--input-bg-light);
            --th-bg: rgba(243, 244, 246, 0.9);
            --hover-bg: rgba(229, 231, 235, 0.5);
            --selected-bg: rgba(196, 181, 253, 0.3);
            --details-bg: rgba(229, 231, 235, 0.4);
            --markdown-pre-bg: rgba(229, 231, 235, 0.8);
            --markdown-code-bg: rgba(209, 213, 219, 0.8);
            --dropdown-bg: var(--dropdown-bg-light);
            --option-hover: var(--option-hover-light);
        }

        .glass {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px 0 var(--shadow-color-current);
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--primary-light), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn {
            padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.3s ease; cursor: pointer; opacity: 1; border: none;
        }
         .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-light); box-shadow: 0 0 10px var(--primary-light); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover:not(:disabled) { opacity: 0.9; box-shadow: 0 0 10px var(--secondary); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-light); box-shadow: 0 0 10px var(--danger); }
        .btn-icon { background: none; border: none; padding: 0.5rem; border-radius: 50%; transition: background-color 0.2s; }
        .btn-icon:hover { background-color: rgba(128, 128, 128, 0.2); }
        .dark .btn-icon:hover { background-color: rgba(255, 255, 255, 0.1); }
        .light .btn-icon:hover { background-color: rgba(0, 0, 0, 0.1); }
        .btn-pagination { padding: 0.3rem 0.6rem; font-size: 0.8rem; background-color: var(--primary); color: white; }
        .btn-pagination:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-pagination:disabled { background-color: var(--border-color); color: var(--text-dark); }
        .dark .btn-pagination:disabled { color: var(--text-light); }


        .tab { display: none; }
        .tab.active { display: block; }
        .tab-btn { border-bottom: 2px solid transparent; transition: border-color 0.3s, color 0.3s; }
        .tab-btn.active { border-bottom: 2px solid var(--primary); color: var(--primary-light); font-weight: 700; }

        .hamburger { display: flex; flex-direction: column; justify-content: space-between; width: 24px; height: 18px; cursor: pointer; }
        .hamburger div { width: 100%; height: 2px; background-color: currentColor; transition: all 0.3s; }
        .hamburger.active div:nth-child(1) { transform: translateY(8px) rotate(45deg); }
        .hamburger.active div:nth-child(2) { opacity: 0; }
        .hamburger.active div:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

        .sidenav { height: 100%; width: 0; position: fixed; z-index: 30; top: 0; left: 0; overflow-y: auto; overflow-x: hidden; transition: 0.3s; padding-top: 60px; border-right: 1px solid var(--border-color); }
        .sidenav.glass { border: none; } /* Remove border if glass */
        .sidenav .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; }

        .filter-item { margin-bottom: 15px; }
        .table-container { overflow-x: auto; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; font-size: 0.9rem; }
        th { background-color: var(--th-bg); font-weight: 600; }
        tr { transition: background-color 0.2s; }
        tr.selected { background-color: var(--selected-bg) !important; }
        tr:hover:not(.selected) { background-color: var(--hover-bg); }

        .input-field {
            padding: 0.5rem; border-radius: 0.375rem; width: 100%; transition: all 0.3s;
            background-color: var(--input-bg); border: 1px solid var(--border-color); color: inherit;
        }
        .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(109, 40, 217, 0.2); }
        /* Specific style for pagination select */
        #rowsPerPageSelect { width: auto; min-width: 70px; padding-left: 0.5rem; padding-right: 2rem; background-size: 1.2em 1.2em; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: right 0.5rem center; background-repeat: no-repeat; }


        .checkbox-container { display: flex; align-items: center; }
        .checkbox-container input[type="checkbox"] { margin-right: 8px; cursor: pointer; }
        .checkbox-container label { cursor: pointer; }
        .manage-columns-container { margin-bottom: 1.5rem; }
        .manage-columns { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .manage-columns.expanded { max-height: 300px; overflow-y: auto; }
        .ai-response { max-height: calc(100vh - 200px); overflow-y: auto; margin-top: 10px; padding: 10px; border-radius: 8px; background-color: rgba(0,0,0,0.05); }
        .dark .ai-response { background-color: rgba(255,255,255,0.05); }
        .feedback-form { padding: 15px; border-radius: 8px; margin-top: 10px; }
        .feedback-item { margin-bottom: 10px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(109, 40, 217, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(109, 40, 217, 0); } 100% { box-shadow: 0 0 0 0 rgba(109, 40, 217, 0); } }
        .pulse-animation { animation: pulse 2s infinite; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom MultiSelect Styles */
        .custom-multiselect-container { position: relative; width: 100%; }
        .custom-multiselect-display { padding: 0.5rem; border-radius: 0.375rem; width: 100%; background-color: var(--input-bg); border: 1px solid var(--border-color); color: inherit; cursor: pointer; display: flex; justify-content: space-between; align-items: center; min-height: 38px; user-select: none; }
        .custom-multiselect-display .placeholder { opacity: 0.6; }
        .custom-multiselect-display .display-text { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding-right: 5px; }
        .custom-multiselect-display .arrow { transition: transform 0.2s ease-in-out; font-size: 0.8em; }
        .custom-multiselect-container.open .custom-multiselect-display { border-bottom-left-radius: 0; border-bottom-right-radius: 0; border-color: var(--primary); }
        .custom-multiselect-container.open .arrow { transform: rotate(180deg); }
        .custom-multiselect-dropdown { position: absolute; top: 100%; left: 0; right: 0; background-color: var(--dropdown-bg); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 0.375rem 0.375rem; max-height: 200px; overflow-y: auto; z-index: 10; display: none; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .custom-multiselect-container.open .custom-multiselect-dropdown { display: block; }
        .custom-multiselect-option { padding: 0.5rem 0.75rem; cursor: pointer; display: flex; align-items: center; transition: background-color 0.2s; }
        .custom-multiselect-option:hover { background-color: var(--option-hover); }
        .custom-multiselect-option input[type="checkbox"] { margin-right: 0.5rem; cursor: pointer; height: 1rem; width: 1rem; }
        .custom-multiselect-option label { cursor: pointer; flex-grow: 1; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        .custom-multiselect-option.select-all-option { border-bottom: 1px solid var(--border-color); font-weight: 600; }

        /* Shortlist Group Styles */
        .shortlist-group details { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; background-color: var(--details-bg); }
        .shortlist-group summary { padding: 0.75rem 1rem; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); list-style: none; }
        .shortlist-group summary::-webkit-details-marker { display: none; }
        .shortlist-group summary::before { content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 0.5rem; transition: transform 0.2s ease-in-out; display: inline-block; font-size: 0.9em; }
        .shortlist-group details[open] > summary::before { transform: rotate(-180deg); }
        .shortlist-group .group-content { padding: 0; }
        .group-delete-btn, .row-delete-btn { background: none; border: none; color: var(--danger); cursor: pointer; padding: 0.25rem 0.5rem; font-size: 0.9em; margin-left: 0.5rem; border-radius: 4px; transition: background-color 0.2s, color 0.2s; }
        .group-delete-btn:hover, .row-delete-btn:hover { background-color: rgba(239, 68, 68, 0.1); color: var(--danger-light); }
        .shortlist-group .table-container { margin-top: 0; border-radius: 0 0 8px 8px; border: none; box-shadow: none; backdrop-filter: none; -webkit-backdrop-filter: none; background-color: transparent; }
        .shortlist-group th:last-child, .shortlist-group td:last-child { text-align: center; }

        /* Markdown formatting */
        .markdown pre { background-color: var(--markdown-pre-bg); padding: 0.75rem; border-radius: 6px; overflow-x: auto; font-size: 0.875em; margin: 0.5rem 0; }
        .markdown code { font-family: 'Courier New', Courier, monospace; }
        .markdown pre code { background-color: transparent; padding: 0; }
        .markdown code:not(pre code) { background-color: var(--markdown-code-bg); padding: 0.1em 0.3em; border-radius: 3px; }

        /* Responsive Layout Adjustments */
        #ai-assistant-wrapper { border-left: 1px solid var(--border-color); }
        .dark #ai-assistant-wrapper { border-left-color: var(--border-dark); }
        .light #ai-assistant-wrapper { border-left-color: var(--border-light); }

    </style>
</head>
<body class="light"> <!-- Start in light mode -->

    <!-- Header -->
    <header class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-20 bg-white dark:bg-gray-800 bg-opacity-80 dark:bg-opacity-80 backdrop-filter backdrop-blur-md">
        <div class="flex items-center">
            <div class="hamburger mr-4 md:hidden" id="menuBtn">
                <div></div> <div></div> <div></div>
            </div>
            <h1 class="text-xl md:text-2xl font-bold gradient-text">Excel Processor</h1>
        </div>
        <div class="flex items-center space-x-3">
             <button id="themeToggleBtn" class="btn-icon text-lg">
                 <i class="fas fa-moon"></i>
             </button>
             <div class="hamburger hidden md:block" id="menuBtnDesktop">
                 <div></div> <div></div> <div></div>
             </div>
        </div>
    </header>

    <!-- Sidenav for Filters and Columns (Fly-out) -->
    <div class="sidenav glass hide-scroll" id="filterSidenav">
        <span class="close-btn" id="closeFilterBtn">×</span>
        <div class="p-4">
            <!-- Column Management Section -->
            <div class="manage-columns-container">
                 <div class="flex justify-between items-center cursor-pointer mb-2" id="manageColumnsToggle">
                     <h2 class="text-lg font-semibold">Manage Columns</h2>
                     <i class="fas fa-chevron-down"></i>
                 </div>
                 <div class="manage-columns hide-scroll" id="manageColumnsSection">
                     <div class="grid grid-cols-1 gap-1 mt-1" id="columnToggleContainer"></div>
                 </div>
            </div>
            <hr class="my-4 border-gray-300 dark:border-gray-600">
            <!-- Filters Section -->
            <div>
                <h2 class="text-lg font-semibold mb-3">Filters</h2>
                <div id="filterContainer">
                    <!-- Static Skills Filter -->
                    <div class="filter-item">
                        <label for="skillsetFilter" class="block mb-1 text-sm font-medium">Skills Filter</label>
                        <input type="text" id="skillsetFilter" class="input-field text-sm" placeholder="Comma-separated skills..." title="Searches skill/competency columns">
                    </div>
                    <!-- Dynamic custom multi-select filters will be added here by JS -->
                </div>
                <button id="applyFiltersBtn" class="btn btn-primary w-full mt-4 text-sm">Apply Filters</button>
                <button id="resetFiltersBtn" class="btn btn-secondary w-full mt-2 text-sm">Reset Filters</button>
            </div>
        </div>
    </div>

    <!-- Main Content Area (Flex wrapper) -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Primary Content Area (Left/Center) -->
        <main class="flex-1 overflow-y-auto p-4 md:p-6">

            <!-- File Upload Section -->
             <section class="glass p-4 rounded-lg mb-6">
                 <div class="flex flex-col items-center">
                     <label for="excelFile" class="btn btn-primary mb-2 pulse-animation text-sm">
                         <i class="fas fa-file-excel mr-2"></i>Upload Excel
                     </label>
                     <input type="file" id="excelFile" accept=".xlsx, .xls" class="hidden">
                     <p id="fileName" class="text-sm opacity-70 mt-1">No file selected</p>
                 </div>
             </section>

            <!-- Tabs and Search Container -->
            <!-- *** RESPONSIVE FIX APPLIED HERE *** -->
            <div class="mb-4 flex flex-wrap items-center border-b border-gray-300 dark:border-gray-600 gap-y-2">
                <!-- Tabs -->
                <div>
                    <button id="allDataTab" class="py-2 px-4 font-medium tab-btn active text-sm">All Data</button>
                    <button id="shortlistedTab" class="py-2 px-4 font-medium tab-btn text-sm">Shortlisted</button>
                </div>
                <!-- Search Input -->
                <div class="relative w-full sm:w-auto sm:ml-auto">
                     <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                         <i class="fas fa-search"></i>
                     </span>
                     <input type="text" id="searchInput" class="input-field pl-10 pr-4 py-1 text-sm w-full sm:w-48 lg:w-64" placeholder="Search data...">
                </div>
            </div>
            <!-- *** END OF RESPONSIVE FIX *** -->


            <!-- All Data Tab Content -->
            <div id="allDataContent" class="tab active">
                <!-- Action Bar -->
                <div class="mb-4 flex items-center">
                     <button id="addToShortlistBtn" class="btn btn-secondary text-sm" disabled>
                         <i class="fas fa-plus-circle mr-2"></i>Add Selected (<span id="selectedRowCount">0</span>)
                     </button>
                     <span id="addShortlistStatus" class="ml-4 text-sm text-green-500 dark:text-green-400"></span>
                </div>
                <!-- Table -->
                <div class="glass table-container">
                    <table id="dataTable">
                        <thead><tr id="tableHeader"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <!-- No Data Message -->
                <div id="noDataMessage" class="text-center py-4 text-gray-500 dark:text-gray-400">
                    <p>Upload an Excel file to get started</p>
                </div>

                <!-- Pagination Controls -->
                <!-- *** RESPONSIVE FIX APPLIED HERE *** -->
                <div id="paginationControls" class="mt-4 flex flex-wrap items-center justify-between gap-4 text-sm"> <!-- Increased gap -->
                    <!-- Rows per page section -->
                    <div class="flex items-center gap-2">
                        <label for="rowsPerPageSelect" class="whitespace-nowrap">Rows per page:</label>
                        <select id="rowsPerPageSelect" class="input-field text-sm py-1">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <!-- Info and Buttons section -->
                    <div class="flex items-center justify-center sm:justify-end gap-2 flex-wrap"> <!-- Added flex-wrap -->
                        <span id="paginationInfo" class="opacity-70 whitespace-nowrap order-first sm:order-none">Showing 0-0 of 0</span> <!-- Control order on wrap -->
                        <button id="prevPageBtn" class="btn btn-pagination" disabled title="Previous Page"><i class="fas fa-chevron-left"></i></button>
                        <button id="nextPageBtn" class="btn btn-pagination" disabled title="Next Page"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <!-- *** END OF RESPONSIVE FIX *** -->
            </div>

            <!-- Shortlisted Tab Content -->
            <div id="shortlistedContent" class="tab">
                 <div class="mb-4 flex flex-wrap gap-2 justify-between items-center">
                     <button id="exportExcelBtn" class="btn btn-secondary text-sm" disabled><i class="fas fa-file-export mr-2"></i>Export Shortlist</button>
                     <button id="clearAllShortlistedBtn" class="btn btn-danger text-sm" disabled><i class="fas fa-trash-alt mr-2"></i>Clear All</button>
                 </div>
                 <div id="shortlistedGroupsContainer"></div>
                 <div id="noShortlistedMessage" class="text-center py-4 text-gray-500 dark:text-gray-400">
                     <p>No items have been shortlisted yet</p>
                 </div>
            </div>

        </main>

        <!-- AI Assistant Area (Right Sidebar) -->
        <aside id="ai-assistant-wrapper" class="w-full md:w-80 lg:w-96 p-4 md:p-6 overflow-y-auto hidden md:flex flex-col glass border-l border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold mb-3 flex items-center"><i class="fas fa-robot mr-2 text-primary"></i>AI Assistant</h2>
            <div class="flex items-center mb-2">
                <input type="text" id="aiQuestion" class="input-field text-sm flex-grow" placeholder="Ask about 'All Data' tab...">
                <button id="askAiBtn" class="btn btn-primary ml-2 text-sm p-2 leading-none"><i class="fas fa-paper-plane"></i></button>
            </div>
            <div id="aiResponseContainer" class="ai-response flex-1 hide-scroll text-sm">
                <p class="text-sm opacity-70">Upload a file and ask a question about its data...</p>
            </div>
        </aside>

         <!-- Feedback Form (Fixed Position) -->
         <div id="feedbackForm" class="feedback-form glass hidden fixed bottom-4 right-4 w-80 z-40 shadow-lg border" >
             <div class="flex justify-between items-center mb-3">
                 <h3 class="text-base font-semibold">Add/Edit Feedback</h3>
                 <button id="cancelFeedbackBtn" class="text-gray-400 hover:text-red-500 text-2xl leading-none">×</button>
             </div>
             <input type="hidden" id="feedbackRowId">
             <div class="feedback-item">
                 <label for="feedbackText" class="block mb-1 text-xs font-medium">Feedback Notes:</label>
                 <textarea id="feedbackText" class="input-field text-sm" rows="4"></textarea>
             </div>
             <div class="feedback-item flex items-center mt-2">
                 <input type="checkbox" id="contactedCheckbox" class="mr-2 h-4 w-4">
                 <label for="contactedCheckbox" class="text-sm">Candidate Contacted</label>
             </div>
             <div class="flex justify-end mt-3">
                 <button id="saveFeedbackBtn" class="btn btn-primary text-sm">Save Feedback</button>
             </div>
         </div>

    </div> <!-- End Main Flex Wrapper -->

    <script>
        // =============== GLOBAL VARIABLES ===============
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY"; // Replace or use secure method
        let excelData = []; let filteredData = []; let shortlistedData = [];
        let allHeaders = []; let visibleColumns = [];
        let skillColumnNames = []; // Columns identified as containing skills
        const skillKeywords = ['skill', 'competency', 'tech', 'tool', 'language']; // Keywords to identify skill columns
        let theme = 'light'; // Default to light mode
        let feedbackData = {}; let currentFileName = null;
        let currentPage = 1;
        let rowsPerPage = 25; // Default value, matching the select element

        // =============== DOM ELEMENTS ===============
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const menuBtn = document.getElementById('menuBtn');
        const menuBtnDesktop = document.getElementById('menuBtnDesktop');
        const filterSidenav = document.getElementById('filterSidenav');
        const closeFilterBtn = document.getElementById('closeFilterBtn');
        const excelFileInput = document.getElementById('excelFile');
        const fileName = document.getElementById('fileName');
        const dataTable = document.getElementById('dataTable');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const noDataMessage = document.getElementById('noDataMessage');
        const shortlistedGroupsContainer = document.getElementById('shortlistedGroupsContainer');
        const noShortlistedMessage = document.getElementById('noShortlistedMessage');
        const filterContainer = document.getElementById('filterContainer');
        let skillsetFilterInput = document.getElementById('skillsetFilter'); // Re-assignable if recreated
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        const searchInput = document.getElementById('searchInput'); // Single search input
        const allDataTab = document.getElementById('allDataTab');
        const shortlistedTab = document.getElementById('shortlistedTab');
        const allDataContent = document.getElementById('allDataContent');
        const shortlistedContent = document.getElementById('shortlistedContent');
        const columnToggleContainer = document.getElementById('columnToggleContainer');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const clearAllShortlistedBtn = document.getElementById('clearAllShortlistedBtn');
        const aiQuestion = document.getElementById('aiQuestion');
        const askAiBtn = document.getElementById('askAiBtn');
        const aiResponseContainer = document.getElementById('aiResponseContainer');
        const manageColumnsToggle = document.getElementById('manageColumnsToggle');
        const manageColumnsSection = document.getElementById('manageColumnsSection');
        const feedbackForm = document.getElementById('feedbackForm');
        const feedbackRowId = document.getElementById('feedbackRowId');
        const feedbackText = document.getElementById('feedbackText');
        const contactedCheckbox = document.getElementById('contactedCheckbox');
        const cancelFeedbackBtn = document.getElementById('cancelFeedbackBtn');
        const saveFeedbackBtn = document.getElementById('saveFeedbackBtn');
        const addToShortlistBtn = document.getElementById('addToShortlistBtn');
        const selectedRowCount = document.getElementById('selectedRowCount');
        const addShortlistStatus = document.getElementById('addShortlistStatus');
        // Pagination elements
        const paginationControls = document.getElementById('paginationControls');
        const rowsPerPageSelect = document.getElementById('rowsPerPageSelect');
        const paginationInfo = document.getElementById('paginationInfo');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');


        // =============== EVENT LISTENERS ===============
        themeToggleBtn.addEventListener('click', toggleTheme);
        menuBtn.addEventListener('click', toggleMenu);
        menuBtnDesktop.addEventListener('click', toggleMenu);
        closeFilterBtn.addEventListener('click', closeMenu);
        excelFileInput.addEventListener('change', handleFileUpload);
        applyFiltersBtn.addEventListener('click', applyFilters);
        resetFiltersBtn.addEventListener('click', resetFilters);
        searchInput.addEventListener('input', debounce(handleSearch, 300));
        allDataTab.addEventListener('click', () => switchTab('all'));
        shortlistedTab.addEventListener('click', () => switchTab('shortlisted'));
        exportExcelBtn.addEventListener('click', exportToExcel);
        clearAllShortlistedBtn.addEventListener('click', clearAllShortlisted);
        askAiBtn.addEventListener('click', askAi);
        aiQuestion.addEventListener('keydown', (e) => { if (e.key === 'Enter') askAi(); });
        manageColumnsToggle.addEventListener('click', toggleManageColumns);
        cancelFeedbackBtn.addEventListener('click', hideFeedbackForm);
        saveFeedbackBtn.addEventListener('click', saveFeedback);
        shortlistedGroupsContainer.addEventListener('click', handleShortlistDeleteClick);
        addToShortlistBtn.addEventListener('click', addSelectedToShortlist);
        tableBody.addEventListener('change', handleTableBodyChange);
        // Pagination Listeners
        rowsPerPageSelect.addEventListener('change', handleRowsPerPageChange);
        prevPageBtn.addEventListener('click', () => changePage(-1));
        nextPageBtn.addEventListener('click', () => changePage(1));
        // Filter Container Listener (Event Delegation)
        filterContainer.addEventListener('click', handleFilterContainerClick);
        document.addEventListener('click', handleDocumentClick);


        // =============== FUNCTIONS ===============

        function debounce(func, wait) {
             let timeout;
             return function executedFunction(...args) {
                 const later = () => { clearTimeout(timeout); func(...args); };
                 clearTimeout(timeout); timeout = setTimeout(later, wait);
             };
        }

        function toggleTheme() {
             const body = document.body;
             const isDark = body.classList.contains('dark');
             theme = isDark ? 'light' : 'dark';
             body.classList.toggle('dark', !isDark);
             body.classList.toggle('light', isDark);
             themeToggleBtn.innerHTML = `<i class="fas ${isDark ? 'fa-moon' : 'fa-sun'}"></i>`;
             filterSidenav.classList.toggle('dark', !isDark);
             filterSidenav.classList.toggle('light', isDark);
             feedbackForm.classList.toggle('dark', !isDark);
             feedbackForm.classList.toggle('light', isDark);
             if (shortlistedContent.classList.contains('active')) renderShortlistedTable();
             if (allDataContent.classList.contains('active')) updatePaginationControls();
        }

        function toggleMenu() {
            menuBtn.classList.toggle('active');
            menuBtnDesktop.classList.toggle('active');
            filterSidenav.style.width = filterSidenav.style.width === "280px" ? "0" : "280px";
        }
        function closeMenu() {
            menuBtn.classList.remove('active');
            menuBtnDesktop.classList.remove('active');
            filterSidenav.style.width = "0";
        }
        function toggleManageColumns() {
            const chevron = manageColumnsToggle.querySelector('i');
            manageColumnsSection.classList.toggle('expanded');
            chevron.classList.toggle('fa-chevron-down'); chevron.classList.toggle('fa-chevron-up');
        }

        function handleFileUpload(e) {
             const file = e.target.files[0]; if (!file) return;
             currentFileName = file.name; fileName.textContent = `Processing: ${currentFileName}...`;
             excelFileInput.disabled = true; document.querySelector('label[for="excelFile"]').classList.remove('pulse-animation');
             addShortlistStatus.textContent = '';
             const reader = new FileReader();
             reader.onload = (event) => {
                 const data = new Uint8Array(event.target.result);
                 try {
                     const workbook = XLSX.read(data, { type: 'array' });
                     if (!workbook.SheetNames?.length) throw new Error("No sheets found.");
                     const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                     const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: "" });
                     if (jsonData.length > 0) {
                         processExcelData(jsonData, currentFileName); fileName.textContent = `Loaded: ${currentFileName}`;
                     } else { alert("File is empty."); resetCurrentFileState(); fileName.textContent = `Empty: ${currentFileName}`; }
                 } catch (error) { console.error("Excel Read Error:", error); alert(`Error reading "${currentFileName}": ${error.message}.`); resetCurrentFileState(); fileName.textContent = `Error: ${currentFileName}`; }
                 finally { excelFileInput.disabled = false; excelFileInput.value = ''; document.querySelector('label[for="excelFile"]').classList.add('pulse-animation'); }
             };
             reader.onerror = () => { console.error("FileReader Error:", reader.error); alert(`Error reading "${currentFileName}".`); resetCurrentFileState(); fileName.textContent = `Read Error: ${currentFileName}`; excelFileInput.disabled = false; excelFileInput.value = ''; document.querySelector('label[for="excelFile"]').classList.add('pulse-animation'); };
             reader.readAsArrayBuffer(file);
        }

        function processExcelData(data, sourceFileName) {
             excelData = []; filteredData = []; skillColumnNames = [];
             allHeaders = data[0].map(h => String(h || '').trim()).filter(Boolean);
             if (allHeaders.length === 0) { alert(`No headers found in "${sourceFileName}".`); resetCurrentFileState(); return; }

             allHeaders.forEach(header => {
                 const lowerHeader = header.toLowerCase();
                 if (skillKeywords.some(keyword => lowerHeader.includes(keyword))) {
                     if (!skillColumnNames.includes(header)) skillColumnNames.push(header);
                 }
             });
             console.log("Identified Skill Columns:", skillColumnNames);

             if (visibleColumns.length === 0 || !allHeaders.some(h => visibleColumns.includes(h))) {
                 visibleColumns = [...allHeaders];
             } else {
                 visibleColumns = visibleColumns.filter(vc => allHeaders.includes(vc));
             }

             let rowsAdded = 0;
             for (let i = 1; i < data.length; i++) {
                 const row = data[i]; if (!row?.length || row.every(cell => cell == null || String(cell).trim() === '')) continue;
                 const rowData = {};
                 for (let j = 0; j < allHeaders.length; j++) {
                     rowData[allHeaders[j]] = row[j] ?? '';
                 }
                 rowData._id = `${sourceFileName}-row-${i}`; rowData._sourceFile = sourceFileName;
                 excelData.push(rowData); rowsAdded++;
             }
             if (rowsAdded === 0) { alert(`No data rows found in "${sourceFileName}".`); resetCurrentFileState(); return; }

             filteredData = [...excelData];
             currentPage = 1;
             rowsPerPage = parseInt(rowsPerPageSelect.value) || 25;

             createColumnToggles();
             createFilterOptions();
             updateShortlistedTab();
             noDataMessage.style.display = 'none';
             noShortlistedMessage.style.display = shortlistedData.length === 0 ? 'block' : 'none';
             paginationControls.style.display = 'flex';

             resetFilters();
             switchTab('all');
        }

        function resetCurrentFileState() {
             excelData = []; filteredData = []; allHeaders = []; skillColumnNames = [];
             visibleColumns = [];
             tableHeader.innerHTML = '<th><input type="checkbox" id="selectAllCheckbox" title="Select/Deselect all rows on this page"></th>';
             tableBody.innerHTML = '';
             const selectAll = document.getElementById('selectAllCheckbox'); if (selectAll) selectAll.disabled = true;
             noDataMessage.style.display = 'block'; noDataMessage.textContent = "Upload an Excel file.";
             paginationControls.style.display = 'none';
             updateAddToShortlistButtonState();
             currentPage = 1;
             updatePaginationControls();
             columnToggleContainer.innerHTML = '';
             searchInput.value = '';

             filterContainer.innerHTML = ''; // Clear everything first
             const skillsDiv = document.createElement('div');
             skillsDiv.className = 'filter-item';
             skillsDiv.innerHTML = `
                 <label for="skillsetFilter" class="block mb-1 text-sm font-medium">Skills Filter</label>
                 <input type="text" id="skillsetFilter" class="input-field text-sm" placeholder="Comma-separated skills..." title="Searches skill/competency columns">
             `;
             filterContainer.appendChild(skillsDiv);
             skillsetFilterInput = document.getElementById('skillsetFilter'); // Re-assign
        }

        function renderTable() {
             tableHeader.innerHTML = ''; tableBody.innerHTML = ''; addShortlistStatus.textContent = '';

             const thCheckbox = document.createElement('th'); const newSelectAllCheckbox = document.createElement('input');
             newSelectAllCheckbox.type = 'checkbox'; newSelectAllCheckbox.id = 'selectAllCheckbox';
             newSelectAllCheckbox.title = 'Select/Deselect all visible rows on this page';
             newSelectAllCheckbox.addEventListener('change', toggleSelectAll);
             thCheckbox.appendChild(newSelectAllCheckbox); tableHeader.appendChild(thCheckbox);
             visibleColumns.forEach(header => { if (allHeaders.includes(header)) { const th = document.createElement('th'); th.textContent = header; tableHeader.appendChild(th); } });

             const startIndex = (currentPage - 1) * rowsPerPage;
             const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
             const pageData = filteredData.slice(startIndex, endIndex);

             pageData.forEach(row => {
                 const tr = document.createElement('tr'); tr.dataset.id = row._id;
                 const checkboxCell = document.createElement('td'); const checkbox = document.createElement('input');
                 checkbox.type = 'checkbox'; checkbox.className = 'row-checkbox'; checkbox.dataset.id = row._id; checkbox.checked = false;
                 checkboxCell.appendChild(checkbox); tr.appendChild(checkboxCell);
                 visibleColumns.forEach(header => { if (allHeaders.includes(header)) { const td = document.createElement('td'); td.textContent = String(row[header] ?? ''); tr.appendChild(td); } });
                 tableBody.appendChild(tr);
             });

             const currentSelectAllCheckbox = document.getElementById('selectAllCheckbox');
             if (currentSelectAllCheckbox) {
                 currentSelectAllCheckbox.disabled = pageData.length === 0;
                 currentSelectAllCheckbox.checked = false;
             }

             noDataMessage.style.display = excelData.length === 0 ? 'block' : (filteredData.length === 0 ? 'block' : 'none');
             if (excelData.length > 0 && filteredData.length === 0) {
                 noDataMessage.textContent = "No data matches filters/search.";
                 paginationControls.style.display = 'none';
             } else if (excelData.length === 0) {
                 noDataMessage.textContent = "Upload an Excel file.";
                 paginationControls.style.display = 'none';
             } else {
                 noDataMessage.style.display = 'none';
                 paginationControls.style.display = 'flex';
             }

             updatePaginationControls();
             updateAddToShortlistButtonState();
        }

        function updatePaginationControls() {
             const totalRows = filteredData.length;
             const totalPages = Math.ceil(totalRows / rowsPerPage);
             currentPage = Math.max(1, Math.min(currentPage, totalPages || 1));

             const startIndex = (currentPage - 1) * rowsPerPage;
             const endIndex = Math.min(startIndex + rowsPerPage, totalRows);

             const startRow = totalRows === 0 ? 0 : startIndex + 1;
             const endRow = endIndex;

             paginationInfo.textContent = `Showing ${startRow}-${endRow} of ${totalRows}`;
             prevPageBtn.disabled = currentPage <= 1;
             nextPageBtn.disabled = currentPage >= totalPages;
             rowsPerPageSelect.value = String(rowsPerPage);
        }

        function handleRowsPerPageChange() {
            rowsPerPage = parseInt(rowsPerPageSelect.value, 10);
            currentPage = 1;
            renderTable();
        }

        function changePage(direction) {
            const totalRows = filteredData.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            currentPage += direction;
            currentPage = Math.max(1, Math.min(currentPage, totalPages));
            renderTable();
        }

        function renderShortlistedTable() {
             shortlistedGroupsContainer.innerHTML = ''; noShortlistedMessage.style.display = shortlistedData.length === 0 ? 'block' : 'none'; if (shortlistedData.length === 0) return;
             const groupedData = shortlistedData.reduce((acc, row) => { const fileKey = row._sourceFile || 'Unknown'; if (!acc[fileKey]) acc[fileKey] = []; acc[fileKey].push(row); return acc; }, {});
             Object.entries(groupedData).forEach(([filename, rows]) => {
                 const groupWrapper = document.createElement('div'); groupWrapper.className = 'shortlist-group';
                 const details = document.createElement('details'); details.open = true;
                 const summary = document.createElement('summary'); const summaryText = document.createElement('span');
                 summaryText.textContent = `${filename} (${rows.length} shortlisted)`; summaryText.className = 'mr-auto';
                 const groupDeleteBtn = document.createElement('button'); groupDeleteBtn.className = 'group-delete-btn';
                 groupDeleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> Del Group'; groupDeleteBtn.title = `Remove all from ${filename}`; groupDeleteBtn.dataset.filename = filename;
                 summary.append(summaryText, groupDeleteBtn);
                 const groupContent = document.createElement('div'); groupContent.className = 'group-content';
                 const tableContainer = document.createElement('div'); tableContainer.className = `table-container ${theme}`;
                 const table = document.createElement('table'); const thead = document.createElement('thead'); const tbody = document.createElement('tbody');
                 table.append(thead, tbody); tableContainer.appendChild(table); groupContent.appendChild(tableContainer);
                 const headerRow = document.createElement('tr');
                 visibleColumns.forEach(header => { const th = document.createElement('th'); th.textContent = header; headerRow.appendChild(th); });
                 headerRow.innerHTML += `<th>Feedback</th><th>Contacted</th><th class="text-center">Action</th>`; thead.appendChild(headerRow);
                 rows.forEach(row => {
                     const tr = document.createElement('tr'); tr.dataset.id = row._id;
                     visibleColumns.forEach(header => { const td = document.createElement('td'); td.textContent = String(row[header] ?? ''); tr.appendChild(td); });
                     const feedbackTd = document.createElement('td'); const feedbackBtn = document.createElement('button');
                     feedbackBtn.innerHTML = '<i class="fas fa-comment-dots"></i>'; feedbackBtn.className = 'p-1 rounded text-white text-xs';
                     const hasFeedback = feedbackData[row._id]?.feedback; feedbackBtn.classList.toggle('bg-blue-500', !!hasFeedback); feedbackBtn.classList.toggle('bg-gray-500', !hasFeedback);
                     feedbackBtn.title = hasFeedback ? `View/Edit: ${feedbackData[row._id].feedback.substring(0,50)}...` : 'Add Feedback';
                     feedbackBtn.addEventListener('click', () => showFeedbackForm(row._id)); feedbackTd.appendChild(feedbackBtn); tr.appendChild(feedbackTd);
                     const contactedTd = document.createElement('td'); const contactedIcon = document.createElement('i');
                     const isContacted = feedbackData[row._id]?.contacted; contactedIcon.className = `fas fa-circle text-xs ${isContacted ? 'text-green-500' : 'text-red-500'}`;
                     contactedIcon.title = isContacted ? 'Contacted' : 'Not Contacted'; contactedTd.appendChild(contactedIcon); tr.appendChild(contactedTd);
                     const deleteTd = document.createElement('td'); deleteTd.className = 'text-center'; const rowDeleteBtn = document.createElement('button');
                     rowDeleteBtn.className = 'row-delete-btn'; rowDeleteBtn.innerHTML = '<i class="fas fa-times"></i>'; rowDeleteBtn.title = 'Remove item';
                     rowDeleteBtn.dataset.id = row._id; deleteTd.appendChild(rowDeleteBtn); tr.appendChild(deleteTd); tbody.appendChild(tr);
                 });
                 details.append(summary, groupContent); groupWrapper.appendChild(details); shortlistedGroupsContainer.appendChild(groupWrapper);
             });
        }

        function updateShortlistedTab() {
             const count = shortlistedData.length;
             shortlistedTab.textContent = `Shortlisted${count > 0 ? ` (${count})` : ''}`;
             if (shortlistedContent.classList.contains('active')) renderShortlistedTable();
             clearAllShortlistedBtn.disabled = count === 0; exportExcelBtn.disabled = count === 0;
             noShortlistedMessage.style.display = count === 0 ? 'block' : 'none';
         }


        // --- Custom MultiSelect Logic ---

        function createFilterOptions() {
             filterContainer.querySelectorAll('.filter-item:not(:first-child)').forEach(el => el.remove());
             const currentFileHeaders = excelData.length > 0 ? Object.keys(excelData[0]).filter(h => h !== '_id' && h !== '_sourceFile') : allHeaders;

             visibleColumns.forEach(header => {
                 if (skillColumnNames.includes(header)) return;
                 if (!currentFileHeaders.includes(header)) return;

                 const uniqueValues = [...new Set(excelData.map(row => row[header]))]
                    .map(val => String(val ?? '').trim()).filter(v => v !== '')
                    .sort((a, b) => a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'}));

                 if (uniqueValues.length > 0 && uniqueValues.length < 150) {
                     const filterItem = document.createElement('div'); filterItem.className = 'filter-item';
                     const label = document.createElement('label');
                     const idBase = `filter-${header.replace(/[^a-zA-Z0-9-_]/g, '-')}`;
                     label.htmlFor = `${idBase}-display`; label.className = 'block mb-1 text-sm font-medium'; label.textContent = header;
                     const container = document.createElement('div'); container.className = 'custom-multiselect-container'; container.dataset.column = header;
                     const display = document.createElement('div'); display.id = `${idBase}-display`; display.className = 'custom-multiselect-display'; display.innerHTML = `<span class="display-text placeholder">Select ${header}...</span><i class="arrow fas fa-chevron-down"></i>`;
                     const dropdown = document.createElement('div'); dropdown.className = 'custom-multiselect-dropdown hide-scroll';
                     const selectAllId = `${idBase}-select-all`; const selectAllOption = document.createElement('div'); selectAllOption.className = 'custom-multiselect-option select-all-option';
                     selectAllOption.innerHTML = `<input type="checkbox" id="${selectAllId}" class="select-all-checkbox"><label for="${selectAllId}">Select All</label>`; dropdown.appendChild(selectAllOption);
                     uniqueValues.forEach((value, index) => {
                         const optionId = `${idBase}-option-${index}`; const option = document.createElement('div'); option.className = 'custom-multiselect-option';
                         option.innerHTML = `<input type="checkbox" id="${optionId}" class="option-checkbox" value="${value}"><label for="${optionId}">${value}</label>`; dropdown.appendChild(option);
                     });
                     container.appendChild(display); container.appendChild(dropdown); filterItem.appendChild(label); filterItem.appendChild(container); filterContainer.appendChild(filterItem);
                 }
             });
        }

        function handleFilterContainerClick(event) {
             const target = event.target;
             const displayArea = target.closest('.custom-multiselect-display');
             if (displayArea) {
                 const container = displayArea.closest('.custom-multiselect-container');
                 if (container) {
                     document.querySelectorAll('.custom-multiselect-container.open').forEach(openContainer => { if (openContainer !== container) openContainer.classList.remove('open'); });
                     container.classList.toggle('open');
                 }
                 return;
             }

             if (target.type === 'checkbox' && target.closest('.custom-multiselect-dropdown')) {
                 const container = target.closest('.custom-multiselect-container'); if (!container) return;
                 const dropdown = container.querySelector('.custom-multiselect-dropdown'); const allOptionCheckboxes = dropdown.querySelectorAll('.option-checkbox'); const selectAllCheckbox = dropdown.querySelector('.select-all-checkbox');
                 if (target.classList.contains('select-all-checkbox')) { const isChecked = target.checked; allOptionCheckboxes.forEach(cb => cb.checked = isChecked); }
                 else if (target.classList.contains('option-checkbox')) { const allChecked = Array.from(allOptionCheckboxes).every(cb => cb.checked); const noneChecked = Array.from(allOptionCheckboxes).every(cb => !cb.checked); selectAllCheckbox.checked = allChecked; selectAllCheckbox.indeterminate = !allChecked && !noneChecked; }
                 updateMultiSelectDisplay(container);
             }
             if (target.closest('.custom-multiselect-dropdown')) event.stopPropagation();
        }

        function handleDocumentClick(event) {
            if (!event.target.closest('.custom-multiselect-container')) {
                document.querySelectorAll('.custom-multiselect-container.open').forEach(container => container.classList.remove('open'));
            }
        }

        function updateMultiSelectDisplay(container) {
            const displaySpan = container.querySelector('.custom-multiselect-display .display-text');
            const dropdown = container.querySelector('.custom-multiselect-dropdown');
            const checkedOptions = dropdown.querySelectorAll('.option-checkbox:checked');
            const placeholder = `Select ${container.dataset.column}...`;

            if (checkedOptions.length === 0) { displaySpan.textContent = placeholder; displaySpan.classList.add('placeholder'); }
            else if (checkedOptions.length === 1) { displaySpan.textContent = checkedOptions[0].value; displaySpan.classList.remove('placeholder'); }
            else { displaySpan.textContent = `${checkedOptions.length} Selected`; displaySpan.classList.remove('placeholder'); }
        }

        // --- End Custom MultiSelect Logic ---


function applyFilters() {
             let currentFiltered = [...excelData];
             // console.log("Initial data length:", currentFiltered.length);

             // 1. Apply Freeform Skills Filter (Corrected Logic)
             const skillsValue = skillsetFilterInput.value.trim().toLowerCase();
             if (skillsValue && skillColumnNames.length > 0) {
                 const skillsToSearch = skillsValue.split(',').map(s => s.trim()).filter(Boolean);
                 if (skillsToSearch.length > 0) {
                     // console.log("Applying Skills Filter. Terms:", skillsToSearch, "Columns:", skillColumnNames);
                     currentFiltered = currentFiltered.filter(row => {
                         // Check if *any* relevant, visible skill column contains *any* of the searched skills
                         return skillColumnNames.some(skillCol => {
                             // Only filter based on visible columns
                             if (!visibleColumns.includes(skillCol)) return false;

                             const cellValue = String(row[skillCol] || '').toLowerCase();
                             // Check if the cell value includes *any* of the search terms
                             return skillsToSearch.some(searchTerm => cellValue.includes(searchTerm));
                         });
                     });
                     // console.log("After Skills Filter, rows:", currentFiltered.length);
                 }
             }

             // 2. Apply Custom Multi-Select Filters
             filterContainer.querySelectorAll('.custom-multiselect-container').forEach(container => {
                 const column = container.dataset.column;
                 const checkedOptions = container.querySelectorAll('.option-checkbox:checked');
                 const selectedValues = Array.from(checkedOptions).map(cb => cb.value);

                 if (selectedValues.length > 0 && column && visibleColumns.includes(column)) {
                     // console.log(`Applying Filter for ${column}. Selected:`, selectedValues);
                     currentFiltered = currentFiltered.filter(row => {
                         const rowValue = String(row[column] || '');
                         // Check if the row's value exactly matches one of the selected values
                         return selectedValues.includes(rowValue);
                     });
                     // console.log(`After ${column} Filter, rows:`, currentFiltered.length);
                 }
             });

             // 3. Apply Global Search Filter
             const search = searchInput.value.toLowerCase().trim();
             if (search !== '') {
                 // console.log("Applying Global Search:", search);
                 currentFiltered = currentFiltered.filter(r =>
                    // Search only within visible columns
                    visibleColumns.some(h => r.hasOwnProperty(h) && String(r[h] || '').toLowerCase().includes(search))
                 );
                 // console.log("After Global Search, rows:", currentFiltered.length);
             }

             filteredData = currentFiltered;
             currentPage = 1; // Reset to first page after filtering
             renderTable();
             closeMenu(); // Close sidenav after applying
        }

        function resetFilters() {
             skillsetFilterInput.value = '';
             filterContainer.querySelectorAll('.custom-multiselect-container').forEach(container => {
                 container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                 const selectAllCheckbox = container.querySelector('.select-all-checkbox');
                 if (selectAllCheckbox) selectAllCheckbox.indeterminate = false;
                 updateMultiSelectDisplay(container);
             });
             searchInput.value = '';
             applyFilters();
        }


        function createColumnToggles() {
            columnToggleContainer.innerHTML = '';
            allHeaders.forEach(header => {
                const div = document.createElement('div'); div.className = 'checkbox-container px-2 py-1 hover:bg-gray-700 dark:hover:bg-gray-600 rounded';
                const check = document.createElement('input'); const id = `toggle-${header.replace(/[^a-zA-Z0-9-_]/g, '-')}`;
                check.type = 'checkbox'; check.id = id; check.dataset.header = header; check.checked = visibleColumns.includes(header);
                check.addEventListener('change', () => toggleColumn(header));
                const label = document.createElement('label'); label.htmlFor = id;
                label.textContent = header; label.className = 'ml-2 cursor-pointer text-sm flex-grow';
                div.append(check, label); columnToggleContainer.appendChild(div);
            });
        }

        function toggleColumn(header) {
             const idx = visibleColumns.indexOf(header);
             if (idx > -1) { visibleColumns.splice(idx, 1); }
             else { const newVis = []; let added = false; allHeaders.forEach(h => { if (visibleColumns.includes(h)) newVis.push(h); else if (h === header) { newVis.push(h); added = true; } }); if (!added) newVis.push(header); visibleColumns = newVis; }
             currentPage = 1;
             renderTable();
             updateShortlistedTab();
             createFilterOptions(); // Regenerate filters based on visibility
         }

        function handleTableBodyChange(event) { if (event.target.classList.contains('row-checkbox')) toggleRowSelectionVisual(event.target); }
        function toggleRowSelectionVisual(checkbox) { const tr = checkbox.closest('tr'); if (tr) tr.classList.toggle('selected', checkbox.checked); updateAddToShortlistButtonState(); }
        function toggleSelectAll() { const isChecked = document.getElementById('selectAllCheckbox').checked; tableBody.querySelectorAll('.row-checkbox').forEach(cb => { if(cb.checked !== isChecked) { cb.checked = isChecked; const tr = cb.closest('tr'); if (tr) tr.classList.toggle('selected', isChecked); } }); updateAddToShortlistButtonState(); }
        function updateAddToShortlistButtonState() { const count = tableBody.querySelectorAll('.row-checkbox:checked').length; selectedRowCount.textContent = count; addToShortlistBtn.disabled = count === 0; }
        function addSelectedToShortlist() {
             const checkboxes = tableBody.querySelectorAll('.row-checkbox:checked'); if (checkboxes.length === 0) return; let added = 0, present = 0;
             checkboxes.forEach(cb => { const id = cb.dataset.id; const row = excelData.find(r => r._id === id); if (row) { if (!shortlistedData.some(sr => sr._id === id)) { shortlistedData.push(row); added++; } else present++; } cb.checked = false; const tr = cb.closest('tr'); if (tr) tr.classList.remove('selected'); });
             const selectAll = document.getElementById('selectAllCheckbox'); if (selectAll) selectAll.checked = false;
             updateAddToShortlistButtonState(); updateShortlistedTab();
             let msg = `${added} item(s) added from current page.`; if (present > 0) msg += ` ${present} already present.`;
             addShortlistStatus.textContent = msg; setTimeout(() => { addShortlistStatus.textContent = ''; }, 4000);
         }

        function handleSearch() { applyFilters(); }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab').forEach(c => c.classList.remove('active'));
            if (tab === 'all') { allDataTab.classList.add('active'); allDataContent.classList.add('active'); if (excelData.length > 0) renderTable(); else updatePaginationControls(); }
            else { shortlistedTab.classList.add('active'); shortlistedContent.classList.add('active'); renderShortlistedTable(); }
            hideFeedbackForm();
        }

        function exportToExcel() {
             if (shortlistedData.length === 0) { alert("No data to export."); return; } try { const headers = [...visibleColumns, 'Feedback', 'Contacted', 'Source File']; const wsData = [headers];
             shortlistedData.forEach(r => { const rd = []; visibleColumns.forEach(h => rd.push(r[h] ?? '')); rd.push(feedbackData[r._id]?.feedback || ''); rd.push(feedbackData[r._id]?.contacted ? 'Yes' : 'No'); rd.push(r._sourceFile || 'Unknown'); wsData.push(rd); });
             const ws = XLSX.utils.aoa_to_sheet(wsData); ws['!cols'] = headers.map(h => ({ wch: h === 'Feedback' ? 40 : (h === 'Source File' ? 25 : 15) })); const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "Shortlisted"); const d = new Date(); const fn = `Shortlisted_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.xlsx`;
             XLSX.writeFile(wb, fn); } catch (e) { console.error("Export Error:", e); alert("Error exporting data."); }
         }

        async function askAi() {
             const q = aiQuestion.value.trim(); if (!q) return; if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") { aiResponseContainer.innerHTML = '<p class="text-yellow-500">AI Assistant requires a valid Gemini API Key.</p>'; return; }
             aiResponseContainer.innerHTML = '<p>🤖 Thinking...</p>'; askAiBtn.disabled = true; aiQuestion.disabled = true;
             const ctxData = filteredData; const ctxHeaders = visibleColumns.filter(h => allHeaders.includes(h));
             if (ctxData.length === 0) { aiResponseContainer.innerHTML = '<p class="text-yellow-500">No data in "All Data" tab to analyze.</p>'; askAiBtn.disabled = false; aiQuestion.disabled = false; return; }
             if (ctxHeaders.length === 0) { aiResponseContainer.innerHTML = '<p class="text-yellow-500">No columns are visible to analyze.</p>'; askAiBtn.disabled = false; aiQuestion.disabled = false; return; }
             try {
                 const sampleSize = Math.min(ctxData.length, 50); let csvSample = ctxHeaders.join(",") + "\n";
                 for (let i = 0; i < sampleSize; i++) csvSample += ctxHeaders.map(h => `"${String(ctxData[i][h] ?? '').replace(/"/g, '""')}"`).join(",") + "\n";
                 const prompt = `Analyze data from "${currentFileName || 'unknown'}". Columns: ${ctxHeaders.join(", ")}. Total matching rows: ${ctxData.length}. Sample (up to ${sampleSize} rows):\n\`\`\`csv\n${csvSample}\`\`\`\nContext: Data may be filtered by user selections.\nQ: ${q}\nAnswer concisely based ONLY on the sample provided. State if insufficient. Use simple markdown.`;
                 const responseText = await fetchGeminiResponse(prompt);
                 aiResponseContainer.innerHTML = `<div class="markdown">${formatAiResponse(responseText)}</div>`; aiQuestion.value = '';
             } catch (e) { console.error("AI Error:", e); aiResponseContainer.innerHTML = `<p class="text-red-500">AI Error: ${e.message}. Check console.</p>`; } finally { askAiBtn.disabled = false; aiQuestion.disabled = false; }
         }

        async function fetchGeminiResponse(prompt) {
             const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
             const requestBody = { contents: [{ parts: [{ text: prompt }] }] }; try { const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(requestBody) }); if (!response.ok) { const errorData = await response.json(); console.error("Gemini API Error Response:", errorData); throw new Error(errorData.error?.message || `API request failed with status ${response.status}`); } const data = await response.json(); if (data.promptFeedback?.blockReason) throw new Error(`Request blocked: ${data.promptFeedback.blockReason}`); const text = data.candidates?.[0]?.content?.parts?.[0]?.text; if (!text) { if (data.candidates?.[0]?.finishReason && data.candidates?.[0]?.finishReason !== 'STOP') throw new Error(`Incomplete: ${data.candidates[0].finishReason}`); throw new Error('Empty AI response.'); } return text; } catch (error) { console.error("Fetch Gemini Error:", error); throw error; }
         }

        function formatAiResponse(text) { return text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/```([\s\S]*?)```/g,'<pre><code>$1</code></pre>').replace(/`(.*?)`/g,'<code>$1</code>').replace(/^\s*[-*+]\s+(.*)$/gm,'<li>$1</li>').replace(/(\n?\s*<li>.*?<\/li>\s*)+/gs, (match) => `<ul>${match.trim()}</ul>`).replace(/\n/g,'<br>'); }

        function showFeedbackForm(id) { feedbackRowId.value = id; const d = feedbackData[id] || {}; feedbackText.value = d.feedback || ''; contactedCheckbox.checked = d.contacted || false; feedbackForm.classList.remove('hidden'); feedbackText.focus(); }
        function hideFeedbackForm() { feedbackForm.classList.add('hidden'); feedbackRowId.value = ''; feedbackText.value = ''; contactedCheckbox.checked = false; }
        function saveFeedback() { const id = feedbackRowId.value; if (!id) return; feedbackData[id] = { feedback: feedbackText.value.trim(), contacted: contactedCheckbox.checked }; if (shortlistedContent.classList.contains('active')) { renderShortlistedTable(); } hideFeedbackForm(); }
        function handleShortlistDeleteClick(event) { const t = event.target; const rb = t.closest('.row-delete-btn'); const gb = t.closest('.group-delete-btn'); if (rb) { const id = rb.dataset.id; if (id) deleteShortlistedRow(id); } else if (gb) { const fn = gb.dataset.filename; if (fn && confirm(`Remove ALL shortlisted items from file "${fn}"?`)) deleteShortlistedGroup(fn); } }
        function deleteShortlistedRow(id) { const initialLength = shortlistedData.length; shortlistedData = shortlistedData.filter(r => r._id !== id); if(shortlistedData.length < initialLength) { delete feedbackData[id]; updateShortlistedTab(); } }
        function deleteShortlistedGroup(filename) { const itemsToRemove = shortlistedData.filter(r => (r._sourceFile || 'Unknown') === filename); if (itemsToRemove.length === 0) return; const idsToRemove = itemsToRemove.map(r => r._id); shortlistedData = shortlistedData.filter(r => (r._sourceFile || 'Unknown') !== filename); idsToRemove.forEach(id => delete feedbackData[id]); updateShortlistedTab(); }
        function clearAllShortlisted() { if (shortlistedData.length === 0) return; if (confirm("Are you sure you want to clear the ENTIRE shortlist? This cannot be undone.")) { shortlistedData = []; feedbackData = {}; updateShortlistedTab(); } }

        function initializeApp() {
             theme = 'light'; document.body.className = 'light'; themeToggleBtn.innerHTML = `<i class="fas fa-moon"></i>`; filterSidenav.className = 'sidenav glass hide-scroll light'; feedbackForm.className = 'feedback-form glass hidden fixed bottom-4 right-4 w-80 z-40 shadow-lg border light';
             rowsPerPage = parseInt(rowsPerPageSelect.value, 10); currentPage = 1; resetCurrentFileState(); updateShortlistedTab(); manageColumnsSection.classList.remove('expanded');
             const chevron = manageColumnsToggle.querySelector('i'); if (chevron) { chevron.className = 'fas fa-chevron-down'; }
             hideFeedbackForm(); switchTab('all'); paginationControls.style.display = 'none';
             if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") { aiResponseContainer.innerHTML = '<p class="text-yellow-500 text-sm">AI needs API Key.</p>'; askAiBtn.disabled = true; aiQuestion.disabled = true; }
             updateAddToShortlistButtonState();
         }
         // Initialize the application on load
         initializeApp();
    </script>
</body>
</html>
