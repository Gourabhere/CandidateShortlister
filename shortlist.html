<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Processor App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    {/* Use the latest version of SheetJS */}
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6d28d9;
            --primary-light: #8b5cf6;
            --secondary: #10b981;
            --accent: #f97316;
            --background-dark: #111827;
            --background-light: #f9fafb;
            --text-dark: #1f2937;
            --text-light: #f3f4f6;
            --card-dark: rgba(17, 24, 39, 0.8);
            --card-light: rgba(249, 250, 251, 0.9);
            --shadow-color-dark: rgba(0, 0, 0, 0.3);
            --shadow-color-light: rgba(107, 114, 128, 0.2);
            --neon-glow: 0 0 10px var(--primary-light);
            --danger: #ef4444;
            --danger-light: #f87171;
        }
        /* Base styles */
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; overflow-x: hidden; }
        /* Light Mode (Default) */
        body.light { background-color: var(--background-light); color: var(--text-dark); --shadow-color: var(--shadow-color-light); }
        .light .glass { background-color: var(--card-light); border: 1px solid rgba(209, 213, 219, 0.3); }
        .light .sidenav { background-color: var(--background-light); }
        .light .input-field { background-color: white; color: var(--text-dark); border: 1px solid #d1d5db; }
        .light th { background-color: #e5e7eb; }
        .light .ai-response { background-color: rgba(229, 231, 235, 0.6); }
        .light .feedback-form { background-color: rgba(243, 244, 246, 0.95); border-color: #e5e7eb; }
        .light .shortlist-group details { background-color: rgba(229, 231, 235, 0.3); border-color: #d1d5db; }
        .light .shortlist-group summary { border-color: #e5e7eb; }
        .light .markdown pre { background-color: #e5e7eb; color: #374151; }
        .light .markdown code:not(pre code) { background-color: #d1d5db; }
        .light .border-b { border-color: #d1d5db; }
        .light th, .light td { border-color: #e5e7eb; }
        .light .hover\:bg-gray-700:hover { background-color: #e5e7eb; }
        .light .text-gray-400 { color: #6b7280; }
        .light .hover\:text-white:hover, .light .hover\:text-red-500:hover { color: #1f2937; }

        /* Dark Mode */
        body.dark { background-color: var(--background-dark); color: var(--text-light); --shadow-color: var(--shadow-color-dark); }
        .dark .glass { background-color: var(--card-dark); border: 1px solid rgba(55, 65, 81, 0.7); }
        .dark .sidenav { background-color: var(--background-dark); }
        .dark .input-field { background-color: #1f2937; color: var(--text-light); border: 1px solid #4b5563; }
        .dark th { background-color: #374151; }
        .dark .ai-response { background-color: rgba(31, 41, 55, 0.7); }
        .dark .feedback-form { background-color: rgba(31, 41, 55, 0.9); border-color: #4b5563;}
        .dark .shortlist-group details { background-color: rgba(55, 65, 81, 0.3); border-color: #4b5563; }
        .dark .shortlist-group summary { border-color: #4b5563; }
        .dark .markdown pre { background-color: #1f2937; color: #d1d5db; }
        .dark .markdown code:not(pre code) { background-color: #4b5563; }
        .dark .border-b { border-color: #4b5563; }
        .dark th, .dark td { border-color: #4b5563; }
        .dark .hover\:bg-gray-700:hover { background-color: #374151; }
        .dark .text-gray-400 { color: #9ca3af; }
        .dark .hover\:text-white:hover { color: #f9fafb; }
        .dark .hover\:text-red-500:hover { color: var(--danger-light); }

        /* General Styles */
        .glass { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: 0 4px 20px 0 var(--shadow-color); border-radius: 0.75rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.3s ease; cursor: pointer; opacity: 1; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none !important; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-light); box-shadow: var(--neon-glow); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover:not(:disabled) { opacity: 0.9; box-shadow: 0 0 10px var(--secondary); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-light); box-shadow: 0 0 10px var(--danger); }
        #themeToggleBtn { background: none; border: 1px solid currentColor; border-radius: 9999px; padding: 0.5rem; cursor: pointer; transition: transform 0.3s ease; }
        #themeToggleBtn:hover { transform: scale(1.1) rotate(15deg); }
        #themeToggleBtn .fa-sun { display: none; } .dark #themeToggleBtn .fa-moon { display: none; } .dark #themeToggleBtn .fa-sun { display: inline-block; }
        .hamburger { display: flex; flex-direction: column; justify-content: space-between; width: 24px; height: 18px; cursor: pointer; }
        .hamburger div { width: 100%; height: 2px; background-color: currentColor; transition: all 0.3s; }
        .hamburger.active div:nth-child(1) { transform: translateY(8px) rotate(45deg); } .hamburger.active div:nth-child(2) { opacity: 0; } .hamburger.active div:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }
        .sidenav { height: 100%; width: 0; position: fixed; z-index: 20; top: 0; left: 0; overflow-y: auto; overflow-x: hidden; transition: width 0.3s ease; padding-top: 60px; }
        .sidenav .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; }
        .filter-item { margin-bottom: 1rem; }
        .table-container { overflow-x: auto; border-radius: 8px; margin-top: 0.75rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid; white-space: nowrap; }
        tr { transition: background-color 0.2s; }
        .light tr:hover:not(.selected) { background-color: #f3f4f6; } .dark tr:hover:not(.selected) { background-color: #374151; }
        tr.selected { background-color: rgba(109, 40, 217, 0.15) !important; }
        .input-field { padding: 0.5rem 0.75rem; border-radius: 0.375rem; width: 100%; transition: border-color 0.3s, box-shadow 0.3s; }
        .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(109, 40, 217, 0.3); }
        select.input-field { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .checkbox-container { display: flex; align-items: center; }
        .checkbox-container input[type="checkbox"], .checkbox-container label { cursor: pointer; }
        .manage-columns-container { margin-bottom: 1.5rem; }
        .manage-columns { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .manage-columns.expanded { max-height: 250px; overflow-y: auto; }
        .ai-response { max-height: none; overflow-y: auto; margin-top: 1rem; padding: 0.75rem; border-radius: 8px; }
        .feedback-form { padding: 1rem; border-radius: 8px; margin-top: 1rem; }
        .feedback-item { margin-bottom: 0.75rem; }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(109, 40, 217, 0); } 70% { box-shadow: 0 0 0 10px rgba(109, 40, 217, 0.7); } }
        .hide-scroll::-webkit-scrollbar { display: none; } .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .shortlist-group details { border: 1px solid; border-radius: 8px; margin-bottom: 1rem; }
        .shortlist-group summary { padding: 0.75rem 1rem; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid; list-style: none; }
        .shortlist-group summary::-webkit-details-marker { display: none; }
        .shortlist-group summary::before { content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 0.5rem; transition: transform 0.2s ease-in-out; display: inline-block; font-size: 0.8em; }
        .shortlist-group details[open] > summary::before { transform: rotate(-180deg); }
        .shortlist-group .group-content { padding: 0; }
        .group-delete-btn, .row-delete-btn { background: none; border: none; color: var(--danger); cursor: pointer; padding: 0.25rem 0.5rem; font-size: 0.85em; margin-left: 0.5rem; border-radius: 4px; transition: all 0.2s; }
        .group-delete-btn:hover, .row-delete-btn:hover { background-color: rgba(239, 68, 68, 0.1); color: var(--danger-light); }
        .shortlist-group .table-container { margin-top: 0; border-radius: 0 0 8px 8px; border: none; box-shadow: none; backdrop-filter: none; -webkit-backdrop-filter: none; background-color: transparent; }
        .shortlist-group th:last-child, .shortlist-group td:last-child { text-align: center; }
        .markdown pre { padding: 0.75rem; border-radius: 6px; overflow-x: auto; font-size: 0.875em; margin: 0.5rem 0; }
        .markdown code { font-family: 'Courier New', Courier, monospace; }
        .markdown pre code { background-color: transparent; padding: 0; }
        .markdown code:not(pre code) { padding: 0.1em 0.3em; border-radius: 3px; }
        .main-layout { display: flex; flex-direction: column; }
        .content-area { flex-grow: 1; width: 100%; }
        .ai-sidebar { width: 100%; margin-top: 1.5rem; }
        @media (min-width: 1024px) { .main-layout { flex-direction: row; gap: 1.5rem; } .content-area { width: 65%; } .ai-sidebar { width: 35%; margin-top: 0; max-height: calc(100vh - 100px); overflow-y: auto; position: sticky; top: 80px; } .ai-sidebar > section { height: 100%; } }
        #feedbackForm { z-index: 30; }
    </style>
</head>
<body class="light">
    <div class="min-h-screen px-4 py-6">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center">
                <button class="hamburger mr-4 lg:hidden" id="menuBtn" aria-label="Toggle Filters Menu"> <div></div> <div></div> <div></div> </button>
                <h1 class="text-2xl font-bold gradient-text">Excel Processor</h1>
            </div>
            <button id="themeToggleBtn" aria-label="Toggle Dark/Light Mode"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button>
        </header>

        <div class="sidenav glass hide-scroll lg:hidden" id="filterSidenav">
            <span class="close-btn" id="closeFilterBtn" aria-label="Close Filters Menu">×</span>
            <div class="p-4">
                <div class="manage-columns-container"> <div class="flex justify-between items-center cursor-pointer" id="manageColumnsToggle"> <h2 class="text-xl font-bold">Columns</h2> <i class="fas fa-chevron-down"></i> </div> <div class="manage-columns hide-scroll" id="manageColumnsSection"> <div class="grid grid-cols-1 gap-1 mt-3" id="columnToggleContainer"></div> </div> </div>
                <div> <h2 class="text-xl font-bold mb-4">Filters</h2> <div id="filterContainer"> <div class="filter-item"> <label for="skillsetFilter" class="block mb-1 font-medium text-sm">Primary Skill</label> <input type="text" id="skillsetFilter" class="input-field text-sm" placeholder="Comma separated skills..."> </div> </div> <button id="applyFiltersBtn" class="btn btn-primary w-full mt-4 text-sm">Apply Filters</button> <button id="resetFiltersBtn" class="btn btn-secondary w-full mt-2 text-sm">Reset Filters</button> </div>
            </div>
        </div>

        <div class="main-layout">
            <div class="content-area">
                <section class="glass p-4 rounded-lg mb-6"> <div class="flex flex-col items-center"> <label for="excelFile" class="btn btn-primary mb-2 pulse-animation"> <i class="fas fa-file-excel mr-2"></i>Upload Excel </label> <input type="file" id="excelFile" accept=".xlsx, .xls" class="hidden"> <p id="fileName" class="text-sm opacity-70 mt-1">No file selected</p> </div> </section>
                <div class="mb-4"> <div class="flex border-b"> <button id="allDataTab" class="py-2 px-4 font-medium tab-btn active">All Data</button> <button id="shortlistedTab" class="py-2 px-4 font-medium tab-btn">Shortlisted</button> </div> <section class="mt-4"> <div class="flex items-center relative"> <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i> <input type="text" id="searchInput" class="input-field pl-10 w-full text-sm" placeholder="Search visible columns..."> </div> </section> </div>
                <div id="allDataContent" class="tab active"> <div class="mb-4 flex items-center"> <button id="addToShortlistBtn" class="btn btn-secondary text-sm" disabled> <i class="fas fa-plus-circle mr-1"></i>Add (<span id="selectedRowCount">0</span>) to Shortlist </button> <span id="addShortlistStatus" class="ml-4 text-sm text-green-500"></span> </div> <div class="glass table-container"> <table id="dataTable"> <thead> <tr id="tableHeader"> <th><input type="checkbox" id="selectAllCheckbox" title="Select/Deselect all in view" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"></th> </tr> </thead> <tbody id="tableBody"></tbody> </table> </div> <div id="noDataMessage" class="text-center py-4 text-gray-500"> Upload an Excel file. </div> </div>
                <div id="shortlistedContent" class="tab"> <div class="mb-4 flex justify-between items-center"> <button id="exportExcelBtn" class="btn btn-secondary text-sm" disabled> <i class="fas fa-file-export mr-1"></i>Export </button> <button id="clearAllShortlistedBtn" class="btn btn-danger text-sm" disabled> <i class="fas fa-trash-alt mr-1"></i>Clear All </button> </div> <div id="shortlistedGroupsContainer"></div> <div id="noShortlistedMessage" class="text-center py-4 text-gray-500"> No items shortlisted yet. </div> </div>
            </div>
            <aside class="ai-sidebar"> <section class="glass p-4 rounded-lg h-full flex flex-col"> <h2 class="text-lg font-medium mb-3 flex items-center"> <i class="fas fa-robot mr-2 text-xl text-primary"></i>AI Assistant </h2> <div class="flex items-center mb-2"> <input type="text" id="aiQuestion" class="input-field text-sm flex-grow" placeholder="Ask about 'All Data'..."> <button id="askAiBtn" class="btn btn-primary ml-2 px-3 py-1.5" aria-label="Ask AI"> <i class="fas fa-paper-plane"></i> </button> </div> <div id="aiResponseContainer" class="ai-response flex-grow hide-scroll"> <p class="text-sm opacity-70">Upload file & ask...</p> </div> </section> </aside>
            <div id="feedbackForm" class="feedback-form glass hidden fixed bottom-4 right-4 w-80 shadow-xl border"> <div class="flex justify-between items-center mb-3"> <h3 class="text-lg font-medium">Feedback</h3> <button id="cancelFeedbackBtn" class="text-gray-400 hover:text-red-500 text-2xl leading-none">×</button> </div> <input type="hidden" id="feedbackRowId"> <div class="feedback-item"> <label for="feedbackText" class="block mb-1 text-xs font-medium uppercase tracking-wider">Notes:</label> <textarea id="feedbackText" class="input-field text-sm" rows="4"></textarea> </div> <div class="feedback-item flex items-center mt-2"> <input type="checkbox" id="contactedCheckbox" class="mr-2 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"> <label for="contactedCheckbox" class="text-sm">Candidate Contacted</label> </div> <div class="flex justify-end mt-3"> <button id="saveFeedbackBtn" class="btn btn-primary text-sm">Save Feedback</button> </div> </div>
        </div>
    </div>

    <script>
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY";
        let excelData = [], filteredData = [], shortlistedData = [], allHeaders = [], visibleColumns = [];
        let theme = 'light', feedbackData = {}, currentFileName = null;

        const dom = { themeToggleBtn: document.getElementById('themeToggleBtn'), menuBtn: document.getElementById('menuBtn'), filterSidenav: document.getElementById('filterSidenav'), closeFilterBtn: document.getElementById('closeFilterBtn'), excelFileInput: document.getElementById('excelFile'), fileName: document.getElementById('fileName'), dataTable: document.getElementById('dataTable'), tableHeader: document.getElementById('tableHeader'), tableBody: document.getElementById('tableBody'), noDataMessage: document.getElementById('noDataMessage'), shortlistedGroupsContainer: document.getElementById('shortlistedGroupsContainer'), noShortlistedMessage: document.getElementById('noShortlistedMessage'), filterContainer: document.getElementById('filterContainer'), applyFiltersBtn: document.getElementById('applyFiltersBtn'), resetFiltersBtn: document.getElementById('resetFiltersBtn'), searchInput: document.getElementById('searchInput'), allDataTab: document.getElementById('allDataTab'), shortlistedTab: document.getElementById('shortlistedTab'), allDataContent: document.getElementById('allDataContent'), shortlistedContent: document.getElementById('shortlistedContent'), columnToggleContainer: document.getElementById('columnToggleContainer'), exportExcelBtn: document.getElementById('exportExcelBtn'), clearAllShortlistedBtn: document.getElementById('clearAllShortlistedBtn'), aiQuestion: document.getElementById('aiQuestion'), askAiBtn: document.getElementById('askAiBtn'), aiResponseContainer: document.getElementById('aiResponseContainer'), manageColumnsToggle: document.getElementById('manageColumnsToggle'), manageColumnsSection: document.getElementById('manageColumnsSection'), feedbackForm: document.getElementById('feedbackForm'), feedbackRowId: document.getElementById('feedbackRowId'), feedbackText: document.getElementById('feedbackText'), contactedCheckbox: document.getElementById('contactedCheckbox'), cancelFeedbackBtn: document.getElementById('cancelFeedbackBtn'), saveFeedbackBtn: document.getElementById('saveFeedbackBtn'), addToShortlistBtn: document.getElementById('addToShortlistBtn'), selectedRowCount: document.getElementById('selectedRowCount'), addShortlistStatus: document.getElementById('addShortlistStatus') };

        dom.themeToggleBtn.addEventListener('click', toggleTheme); dom.menuBtn.addEventListener('click', toggleMenu); dom.closeFilterBtn.addEventListener('click', closeMenu); dom.excelFileInput.addEventListener('change', handleFileUpload); dom.applyFiltersBtn.addEventListener('click', applyFilters); dom.resetFiltersBtn.addEventListener('click', resetFilters); dom.searchInput.addEventListener('input', debounce(handleSearch, 300)); dom.allDataTab.addEventListener('click', () => switchTab('all')); dom.shortlistedTab.addEventListener('click', () => switchTab('shortlisted')); dom.exportExcelBtn.addEventListener('click', exportToExcel); dom.clearAllShortlistedBtn.addEventListener('click', clearAllShortlisted); dom.askAiBtn.addEventListener('click', askAi); dom.aiQuestion.addEventListener('keydown', (e) => { if (e.key === 'Enter') askAi(); }); dom.manageColumnsToggle.addEventListener('click', toggleManageColumns); dom.cancelFeedbackBtn.addEventListener('click', hideFeedbackForm); dom.saveFeedbackBtn.addEventListener('click', saveFeedback); dom.shortlistedGroupsContainer.addEventListener('click', handleShortlistDeleteClick); dom.addToShortlistBtn.addEventListener('click', addSelectedToShortlist); dom.tableBody.addEventListener('change', handleTableBodyChange);

        function debounce(f, w) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f(...a), w); }; }
        function applyTheme(newTheme) { theme = newTheme; document.body.className = theme; if (dom.shortlistedContent.classList.contains('active')) renderShortlistedTable(); }
        function toggleTheme() { applyTheme(theme === 'light' ? 'dark' : 'light'); }
        function toggleMenu() { dom.menuBtn.classList.toggle('active'); dom.filterSidenav.style.width = dom.filterSidenav.style.width === "280px" ? "0" : "280px"; }
        function closeMenu() { dom.menuBtn.classList.remove('active'); dom.filterSidenav.style.width = "0"; }
        function toggleManageColumns() { const i = dom.manageColumnsToggle.querySelector('i'); dom.manageColumnsSection.classList.toggle('expanded'); i.classList.toggle('fa-chevron-down'); i.classList.toggle('fa-chevron-up'); }

        function handleFileUpload(e) { const f = e.target.files[0]; if (!f) return; currentFileName = f.name; dom.fileName.textContent = `Processing: ${currentFileName}...`; dom.excelFileInput.disabled = true; dom.addShortlistStatus.textContent = ''; document.querySelector('label[for="excelFile"]').classList.remove('pulse-animation'); const r = new FileReader(); r.onload = (ev) => readFileData(new Uint8Array(ev.target.result), currentFileName); r.onerror = () => handleFileReadError(`Error reading "${currentFileName}".`); r.readAsArrayBuffer(f); }
        function readFileData(data, filename, password = null) { try { const opts = { type: 'array' }; if (password) opts.password = password; const wb = XLSX.read(data, opts); if (!wb.SheetNames?.length) throw new Error("No sheets found."); const ws = wb.Sheets[wb.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" }); if (json.length > 0) { processExcelData(json, filename); dom.fileName.textContent = `Loaded: ${filename}`; } else handleFileReadError(`"${filename}" is empty.`, filename); resetUploadUI(); } catch (err) { console.error("XLSX Read Error:", err, err.stack); const errorMsg = String(err.message || err); if (!password && (errorMsg.includes('password') || errorMsg.includes('encrypted') || errorMsg.includes('Incorrect Password') || err.code === 'PPERR')) { const pwd = prompt(`"${filename}" needs password:`); if (pwd !== null && pwd !== "") readFileData(data, filename, pwd); else { handleFileReadError(`Password needed for "${filename}".`, filename); resetUploadUI(); } } else if (password && errorMsg.includes('Incorrect Password')) { handleFileReadError(`Incorrect password for "${filename}".`, filename); resetUploadUI(); } else { handleFileReadError(`Error processing "${filename}": ${errorMsg}`, filename); resetUploadUI(); } } }
        function handleFileReadError(msg, fname = "file") { alert(msg); resetCurrentFileState(); dom.fileName.textContent = `Error: ${fname}`; }
        function resetUploadUI() { dom.excelFileInput.disabled = false; dom.excelFileInput.value = ''; document.querySelector('label[for="excelFile"]').classList.add('pulse-animation'); }

        function processExcelData(data, sourceFileName) { excelData = []; filteredData = []; allHeaders = data[0].map(h => String(h || '').trim()).filter(Boolean); if (allHeaders.length === 0) { handleFileReadError(`No headers in "${sourceFileName}".`, sourceFileName); return; } if (visibleColumns.length === 0) visibleColumns = [...allHeaders]; let rowsAdded = 0; for (let i = 1; i < data.length; i++) { const row = data[i]; if (!row || !row.length || row.every(c => c == null || String(c).trim() === '')) continue; const rowData = { _sourceFile: sourceFileName, _id: `${sourceFileName}-row-${i}` }; allHeaders.forEach((h, j) => rowData[h] = row[j] ?? ''); excelData.push(rowData); rowsAdded++; } if (rowsAdded === 0) { handleFileReadError(`No data rows in "${sourceFileName}".`, sourceFileName); return; } filteredData = [...excelData]; createColumnToggles(); renderTable(); createFilterOptions(); updateShortlistedTab(); dom.noDataMessage.style.display = 'none'; dom.noShortlistedMessage.style.display = shortlistedData.length === 0 ? 'block' : 'none'; switchTab('all'); resetFilters(); dom.searchInput.value = ''; updateAddToShortlistButtonState(); }
        function resetCurrentFileState() { excelData = []; filteredData = []; allHeaders = []; dom.tableHeader.innerHTML = '<th><input type="checkbox" id="selectAllCheckbox" title="Select/Deselect all in view" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"></th>'; dom.tableBody.innerHTML = ''; const sa = document.getElementById('selectAllCheckbox'); if (sa) { sa.checked = false; sa.disabled = true; } dom.noDataMessage.style.display = 'block'; dom.noDataMessage.textContent = "Upload Excel file."; updateAddToShortlistButtonState(); }

        function renderTable() { dom.tableHeader.innerHTML = ''; dom.tableBody.innerHTML = ''; dom.addShortlistStatus.textContent = ''; const thc = document.createElement('th'); const sac = document.createElement('input'); sac.type = 'checkbox'; sac.id = 'selectAllCheckbox'; sac.title = 'Select/Deselect all visible'; sac.className = "h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"; sac.addEventListener('change', toggleSelectAll); thc.appendChild(sac); dom.tableHeader.appendChild(thc); visibleColumns.forEach(h => { if (allHeaders.includes(h)) { const th = document.createElement('th'); th.textContent = h; dom.tableHeader.appendChild(th); } }); filteredData.forEach(r => { const tr = document.createElement('tr'); tr.dataset.id = r._id; const cbc = document.createElement('td'); const cb = document.createElement('input'); cb.type = 'checkbox'; cb.className = 'row-checkbox h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded'; cb.dataset.id = r._id; cb.checked = false; cbc.appendChild(cb); tr.appendChild(cbc); visibleColumns.forEach(h => { if (allHeaders.includes(h)) { const td = document.createElement('td'); td.textContent = String(r[h] ?? ''); tr.appendChild(td); } }); dom.tableBody.appendChild(tr); }); const currSA = document.getElementById('selectAllCheckbox'); if (currSA) { currSA.disabled = filteredData.length === 0; currSA.checked = false; } dom.noDataMessage.style.display = excelData.length === 0 ? 'block' : (filteredData.length === 0 ? 'block' : 'none'); if (excelData.length > 0 && filteredData.length === 0) dom.noDataMessage.textContent = "No data matches filters/search."; else if (excelData.length === 0) dom.noDataMessage.textContent = "Upload Excel file."; updateAddToShortlistButtonState(); }
        function renderShortlistedTable() { dom.shortlistedGroupsContainer.innerHTML = ''; dom.noShortlistedMessage.style.display = shortlistedData.length === 0 ? 'block' : 'none'; if (shortlistedData.length === 0) return; const grouped = shortlistedData.reduce((a, r) => { (a[r._sourceFile || 'Unknown'] = a[r._sourceFile || 'Unknown'] || []).push(r); return a; }, {}); Object.entries(grouped).forEach(([fname, rows]) => { const wrap = document.createElement('div'); wrap.className = 'shortlist-group'; const det = document.createElement('details'); det.open = true; const sum = document.createElement('summary'); const stxt = document.createElement('span'); stxt.textContent = `${fname} (${rows.length})`; stxt.className = 'mr-auto font-semibold'; const gdb = document.createElement('button'); gdb.className = 'group-delete-btn'; gdb.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> Del Group'; gdb.title = `Remove all from ${fname}`; gdb.dataset.filename = fname; sum.append(stxt, gdb); const cont = document.createElement('div'); cont.className = 'group-content'; const tc = document.createElement('div'); tc.className = `glass table-container ${theme}`; const tab = document.createElement('table'), thd = document.createElement('thead'), tbd = document.createElement('tbody'); tab.append(thd, tbd); tc.appendChild(tab); cont.appendChild(tc); const hr = document.createElement('tr'); visibleColumns.forEach(h => { const th = document.createElement('th'); th.textContent = h; hr.appendChild(th); }); hr.innerHTML += `<th>Feedback</th><th>Contacted</th><th class="text-center">Action</th>`; thd.appendChild(hr); rows.forEach(r => { const tr = document.createElement('tr'); tr.dataset.id = r._id; visibleColumns.forEach(h => { const td = document.createElement('td'); td.textContent = String(r[h] ?? ''); tr.appendChild(td); }); const ftd = document.createElement('td'); const fb = document.createElement('button'); fb.innerHTML = '<i class="fas fa-comment-dots"></i>'; fb.className = 'p-1 rounded text-white text-xs'; const hf = feedbackData[r._id]?.feedback; fb.classList.add(hf ? 'bg-blue-500' : 'bg-gray-500'); fb.title = hf ? `View/Edit: ${feedbackData[r._id].feedback.substring(0,50)}...` : 'Add Feedback'; fb.onclick = () => showFeedbackForm(r._id); ftd.appendChild(fb); tr.appendChild(ftd); const ctd = document.createElement('td'); const ci = document.createElement('i'); const isc = feedbackData[r._id]?.contacted; ci.className = `fas fa-circle text-xs ${isc ? 'text-green-500' : 'text-red-500'}`; ci.title = isc ? 'Contacted' : 'Not Contacted'; ctd.appendChild(ci); tr.appendChild(ctd); const dtd = document.createElement('td'); dtd.className = 'text-center'; const rdb = document.createElement('button'); rdb.className = 'row-delete-btn'; rdb.innerHTML = '<i class="fas fa-times"></i>'; rdb.title = 'Remove'; rdb.dataset.id = r._id; dtd.appendChild(rdb); tr.appendChild(dtd); tbd.appendChild(tr); }); det.append(sum, cont); wrap.appendChild(det); dom.shortlistedGroupsContainer.appendChild(wrap); }); }
        function updateShortlistedTab() { const c = shortlistedData.length; dom.shortlistedTab.textContent = `Shortlisted${c > 0 ? ` (${c})` : ''}`; if (dom.shortlistedContent.classList.contains('active')) renderShortlistedTable(); dom.clearAllShortlistedBtn.disabled = c === 0; dom.exportExcelBtn.disabled = c === 0; }

        function createFilterOptions() { const sfi = dom.filterContainer.querySelector('.filter-item:first-child'); dom.filterContainer.innerHTML = ''; if (sfi) dom.filterContainer.appendChild(sfi); const headers = excelData.length > 0 ? Object.keys(excelData[0]).filter(h => !h.startsWith('_')) : allHeaders; visibleColumns.forEach(h => { if (!headers.includes(h)) return; const isPS = h.toLowerCase() === 'primary skill'; if (isPS) { const l = dom.filterContainer.querySelector('label[for="skillsetFilter"]'); if (l) l.textContent = h; return; } const vals = [...new Set(excelData.map(r => r[h]))].map(v => String(v ?? '').trim()).filter(v => v !== '').sort((a, b) => a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'})); if (vals.length > 0 && vals.length < 150) { const item = document.createElement('div'); item.className = 'filter-item'; const l = document.createElement('label'); const id = `filter-${h.replace(/[^a-zA-Z0-9-_]/g, '-')}`; l.htmlFor = id; l.className = 'block mb-1 text-sm font-medium'; l.textContent = h; const sel = document.createElement('select'); sel.id = id; sel.className = 'input-field text-sm'; sel.dataset.column = h; sel.innerHTML = `<option value="">-- Select ${h} --</option>`; vals.forEach(v => { const opt = document.createElement('option'); opt.value = v; opt.textContent = v; sel.appendChild(opt); }); item.append(l, sel); dom.filterContainer.appendChild(item); } }); }
        function applyFilters() { let cf = [...excelData]; const sfi = document.getElementById('skillsetFilter'); const psh = allHeaders.find(h => h.toLowerCase() === 'primary skill'); if (psh && sfi && visibleColumns.includes(psh)) { const fv = sfi.value.trim().toLowerCase(); if (fv) { const sk = fv.split(',').map(s => s.trim()).filter(Boolean); if (sk.length > 0) cf = cf.filter(r => sk.some(s => String(r[psh] || '').toLowerCase().includes(s))); } } dom.filterContainer.querySelectorAll('select').forEach(f => { const v = f.value; const c = f.dataset.column; if (v && c && visibleColumns.includes(c)) cf = cf.filter(r => String(r[c] || '') === v); }); const st = dom.searchInput.value.toLowerCase().trim(); if (st !== '') cf = cf.filter(r => visibleColumns.some(h => r.hasOwnProperty(h) && String(r[h] || '').toLowerCase().includes(st))); filteredData = cf; renderTable(); closeMenu(); }
        function resetFilters() { const sf = document.getElementById('skillsetFilter'); if (sf) sf.value = ''; dom.filterContainer.querySelectorAll('select').forEach(s => s.value = ''); dom.searchInput.value = ''; applyFilters(); }

        function createColumnToggles() { dom.columnToggleContainer.innerHTML = ''; allHeaders.forEach(h => { const d = document.createElement('div'); d.className = 'checkbox-container px-2 py-1 hover:bg-gray-700 rounded'; const c = document.createElement('input'); const id = `toggle-${h.replace(/[^a-zA-Z0-9-_]/g, '-')}`; c.type = 'checkbox'; c.id = id; c.dataset.header = h; c.checked = visibleColumns.includes(h); c.className = "h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"; c.onchange = () => toggleColumn(h); const l = document.createElement('label'); l.htmlFor = id; l.textContent = h; l.className = 'ml-2 text-sm flex-grow cursor-pointer'; d.append(c, l); dom.columnToggleContainer.appendChild(d); }); }
        function toggleColumn(h) { const i = visibleColumns.indexOf(h); if (i > -1) visibleColumns.splice(i, 1); else { const nv = []; let add = false; allHeaders.forEach(ah => { if (visibleColumns.includes(ah)) nv.push(ah); else if (ah === h) { nv.push(h); add = true; } }); if (!add) nv.push(h); visibleColumns = nv; } renderTable(); updateShortlistedTab(); createFilterOptions(); }

        function handleTableBodyChange(e) { if (e.target.classList.contains('row-checkbox')) toggleRowSelectionVisuals(e.target); }
        function toggleRowSelectionVisuals(cb) { const tr = cb.closest('tr'); if (tr) tr.classList.toggle('selected', cb.checked); updateAddToShortlistButtonState(); }
        function toggleSelectAll() { const ic = document.getElementById('selectAllCheckbox').checked; dom.tableBody.querySelectorAll('.row-checkbox').forEach(cb => { if (cb.checked !== ic) { cb.checked = ic; const tr = cb.closest('tr'); if (tr) tr.classList.toggle('selected', ic); } }); updateAddToShortlistButtonState(); }
        function updateAddToShortlistButtonState() { const c = dom.tableBody.querySelectorAll('.row-checkbox:checked').length; dom.selectedRowCount.textContent = c; dom.addToShortlistBtn.disabled = c === 0; }
        function addSelectedToShortlist() { const selCBs = dom.tableBody.querySelectorAll('.row-checkbox:checked'); if (selCBs.length === 0) return; let addC = 0, presC = 0; selCBs.forEach(cb => { const rid = cb.dataset.id; const row = excelData.find(r => r._id === rid); if (row) { if (!shortlistedData.some(sr => sr._id === rid)) { shortlistedData.push(row); addC++; } else presC++; } cb.checked = false; const tr = cb.closest('tr'); if (tr) tr.classList.remove('selected'); }); const sa = document.getElementById('selectAllCheckbox'); if (sa) sa.checked = false; updateAddToShortlistButtonState(); updateShortlistedTab(); let stat = `${addC} added.`; if (presC > 0) stat += ` ${presC} already present.`; dom.addShortlistStatus.textContent = stat; setTimeout(() => { dom.addShortlistStatus.textContent = ''; }, 4000); }

        function handleSearch() { applyFilters(); }
        function switchTab(t) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.tab').forEach(c => c.classList.remove('active')); if (t === 'all') { dom.allDataTab.classList.add('active'); dom.allDataContent.classList.add('active'); renderTable(); } else { dom.shortlistedTab.classList.add('active'); dom.shortlistedContent.classList.add('active'); renderShortlistedTable(); } hideFeedbackForm(); }
        function exportToExcel() { if (shortlistedData.length === 0) { alert("No data."); return; } try { const hdrs = [...visibleColumns, 'Feedback', 'Contacted', 'Source File']; const wsD = [hdrs]; shortlistedData.forEach(r => { const rd = []; visibleColumns.forEach(h => rd.push(r[h] ?? '')); rd.push(feedbackData[r._id]?.feedback || ''); rd.push(feedbackData[r._id]?.contacted ? 'Yes' : 'No'); rd.push(r._sourceFile || 'Unknown'); wsD.push(rd); }); const ws = XLSX.utils.aoa_to_sheet(wsD); ws['!cols'] = hdrs.map(h => ({ wch: h === 'Feedback' ? 40 : (h === 'Source File' ? 25 : 15) })); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Shortlisted"); const d = new Date(); const fn = `Shortlisted_${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.xlsx`; XLSX.writeFile(wb, fn); } catch (e) { console.error("Export Err:", e); alert("Export failed."); } }
        async function askAi() { const q = dom.aiQuestion.value.trim(); if (!q) return; if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") { dom.aiResponseContainer.innerHTML = '<p class="text-yellow-500">AI needs API Key.</p>'; return; } dom.aiResponseContainer.innerHTML = '<p>🤖 Thinking...</p>'; dom.askAiBtn.disabled = true; dom.aiQuestion.disabled = true; const cd = filteredData, ch = visibleColumns.filter(h => allHeaders.includes(h)); if (cd.length === 0) { dom.aiResponseContainer.innerHTML = '<p class="text-yellow-500">No data in "All Data".</p>'; dom.askAiBtn.disabled = false; dom.aiQuestion.disabled = false; return; } if (ch.length === 0) { dom.aiResponseContainer.innerHTML = '<p class="text-yellow-500">No columns visible.</p>'; dom.askAiBtn.disabled = false; dom.aiQuestion.disabled = false; return; } try { let dt = ch.join(", ") + "\n"; const ss = Math.min(cd.length, 30); for (let i = 0; i < ss; i++) dt += ch.map(h => String(cd[i][h] ?? '').replace(/,/g, ';') ).join(", ") + "\n"; const p = `Analyze data from "${currentFileName || 'unknown'}". Cols: ${ch.join(", ")}. Sample (${ss} rows):\n\`\`\`csv\n${dt}\`\`\`\nContext: Filtered subset.\nQ: ${q}\nAnswer concisely based ONLY on sample. State if insufficient. Use simple markdown.`; const rsp = await fetchGeminiResponse(p); dom.aiResponseContainer.innerHTML = `<div class="markdown">${formatAiResponse(rsp)}</div>`; dom.aiQuestion.value = ''; } catch (e) { console.error("AI Err:", e); dom.aiResponseContainer.innerHTML = `<p class="text-red-500">AI Error: ${e.message}.</p>`; } finally { dom.askAiBtn.disabled = false; dom.aiQuestion.disabled = false; } }
        async function fetchGeminiResponse(p) { const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`; const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: p }] }] }) }); if (!r.ok) { const ed = await r.json(); throw new Error(ed.error?.message || `API Err ${r.status}`); } const d = await r.json(); if (d.promptFeedback?.blockReason) throw new Error(`Blocked: ${d.promptFeedback.blockReason}`); if (!d.candidates?.[0]?.content?.parts?.[0]?.text) { if (d.candidates?.[0]?.finishReason && d.candidates[0].finishReason !== 'STOP') throw new Error(`Incomplete: ${d.candidates[0].finishReason}`); throw new Error('Invalid AI response.'); } return d.candidates[0].content.parts[0].text;}
        function formatAiResponse(t) { return t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>').replace(/`(.*?)`/g, '<code>$1</code>').replace(/^\s*[-*+]\s+(.*)$/gm, '<li>$1</li>').replace(/(\n?\s*<li>.*?<\/li>\s*)+/gs, m => `<ul>${m}</ul>`).replace(/\n/g, '<br>'); }
        function showFeedbackForm(rid) { dom.feedbackRowId.value = rid; const d = feedbackData[rid] || {}; dom.feedbackText.value = d.feedback || ''; dom.contactedCheckbox.checked = d.contacted || false; dom.feedbackForm.classList.remove('hidden'); dom.feedbackText.focus(); }
        function hideFeedbackForm() { dom.feedbackForm.classList.add('hidden'); dom.feedbackRowId.value = ''; dom.feedbackText.value = ''; dom.contactedCheckbox.checked = false; }
        function saveFeedback() { const rid = dom.feedbackRowId.value; if (!rid) return; feedbackData[rid] = { feedback: dom.feedbackText.value.trim(), contacted: dom.contactedCheckbox.checked }; if (dom.shortlistedContent.classList.contains('active')) { const re = dom.shortlistedGroupsContainer.querySelector(`tr[data-id="${rid}"]`); if (re) { const fb = re.querySelector('button[title*="Feedback"]'); if(fb) { const hf = feedbackData[rid].feedback; fb.classList.remove('bg-blue-500', 'bg-gray-500'); fb.classList.add(hf ? 'bg-blue-500' : 'bg-gray-500'); fb.title = hf ? `View/Edit: ${feedbackData[rid].feedback.substring(0,50)}...` : 'Add Feedback'; } const ci = re.querySelector('td:nth-last-child(2) i'); if(ci) { const isc = feedbackData[rid].contacted; ci.className = `fas fa-circle text-xs ${isc ? 'text-green-500' : 'text-red-500'}`; ci.title = isc ? 'Contacted' : 'Not Contacted'; } } else renderShortlistedTable(); } hideFeedbackForm(); }
        function handleShortlistDeleteClick(e) { const t = e.target; const rb = t.closest('.row-delete-btn'); const gb = t.closest('.group-delete-btn'); if (rb) { const id = rb.dataset.id; if (id) deleteShortlistedRow(id); } else if (gb) { const fn = gb.dataset.filename; if (fn && confirm(`Remove ALL from "${fn}"?`)) deleteShortlistedGroup(fn); } }
        function deleteShortlistedRow(rid) { const l = shortlistedData.length; shortlistedData = shortlistedData.filter(r => r._id !== rid); if (shortlistedData.length < l) { delete feedbackData[rid]; updateShortlistedTab(); } }
        function deleteShortlistedGroup(fname) { const rows = shortlistedData.filter(r => (r._sourceFile || 'Unknown') === fname); if (rows.length === 0) return; const ids = rows.map(r => r._id); shortlistedData = shortlistedData.filter(r => (r._sourceFile || 'Unknown') !== fname); ids.forEach(id => delete feedbackData[id]); updateShortlistedTab(); }
        function clearAllShortlisted() { if (shortlistedData.length === 0) return; if (confirm("Clear ENTIRE shortlist?")) { shortlistedData = []; feedbackData = {}; updateShortlistedTab(); } }

        function initializeApp() { applyTheme('light'); resetCurrentFileState(); updateShortlistedTab(); dom.noShortlistedMessage.style.display = shortlistedData.length === 0 ? 'block' : 'none'; dom.manageColumnsSection.classList.remove('expanded'); const c = dom.manageColumnsToggle.querySelector('i'); if (c) c.classList.add('fa-chevron-down'); hideFeedbackForm(); switchTab('all'); if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") { dom.aiResponseContainer.innerHTML = '<p class="text-yellow-500 text-sm">AI needs API Key.</p>'; dom.askAiBtn.disabled = true; dom.aiQuestion.disabled = true; } updateAddToShortlistButtonState(); }
        initializeApp();
    </script>
</body>
</html>